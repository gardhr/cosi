[![GitHub license](https://img.shields.io/badge/license-MIT-blue.svg)](https://opensource.org/licenses/MIT)
[![GitHub license](https://img.shields.io/badge/license-ISC-blue.svg)](https://opensource.org/licenses/ISC)

This software is released under [a dual MIT/ISC license](https://raw.githubusercontent.com/gardhr/cosi/master/LICENSE).

# Cosi (Javascript Native Runtime)

Based on the [MuJS](https://mujs.com) Javascript (ES5) engine, Cosi provides a direct interface to most of the ISO C standard API. 

## Installation

The easiest way to use the Cosi library is to simply include "cosi_core.c" and then compile and run (same goes for the default interpreter/driver "cosi.c"). Otherwise just define "cosi_standard_linkage" and compile the ".c" files separately as normal.

To compile to cosi file interpreter:

`
git clone https://github.com/gardhr/cosi
cd cosi
clang -o cosi -lm cosi.c
./cosi
`

## Examples

For now Javascript and C examples can found in "main.js" and "cosi.c".

## Status

Cosi is still very much in the early stages of development. At this point however the code does seem pretty stable. So enjoy!  

## Caveats

Proper use of Cosi requires at the very least a fairly basic understanding of the C programming language.
The library performs little to no preprocessing of arguments passed to the C API functions and so naturally if used incorrectly problems such as abnormal program termination can easily arise. Bottom line, C API functions should be used with extreme care. Consider wrapping raw C calls inside of "safer" Javascript versions of those functions.

## C API

`cosi cosi_create_from(js_Alloc alloc, void* context, int flags)`

Create a new Cosi instance using a MuJS-compliant allocator and allocator "context" (for most applications these can both be NULL). The flags parameter currently only supports the JS_STRICT flag.

`cosi cosi_create(void)`
 
Creates a new (strict-mode) Cosi instance using the default allocator. 

`cosi cosi_destroy(cosi J)`

Deletes a Cosi instance.

`cosi_bool cosi_extend(cosi J, const char* symbol, void (*code)(cosi))`

Maps a MuJS-compliant custom handler to a new global Javascript function.  

`cosi_bool cosi_define(cosi J, const char* symbol, double value)`

Defines a new global Javascript (Number) variable.

`cosi_bool cosi_declare(cosi J, const char* symbol, void* value)`

Declares a new global Javascript "blob" (C pointer) variable.

`cosi_bool cosi_run(cosi J, const char* script)`

Runs some Javascript code.

`cosi_bool cosi_include(cosi J, const char* file)`

Expands the code from "file" directly into the current global space.

`void cosi_main(cosi J, char** argv, char** envp)`

Gives scripts access to argv and envp.

`void cosi_set_global(cosi J)`

Set the global Cosi object. 

`cosi cosi_get_global(void)`

Get the global Cosi object. 
 
`const char* cosi_message(cosi J)`

Returns the error message generated by the last Cosi operation (if any).

`cosi_bool cosi_success(cosi J)`

Returns the result of the last Cosi operation.

NOTE: Pass NULL as the cosi handle to any of the above functions in order to use the global cosi instance (one will be created if none exists).

## Javascript API

`function text_to_bytes(text)`

Returns a pointer to a buffer containing the contents of a String. Memory management of the buffer is the responsibility of the caller (use the free() function). 

`function bytes_to_text(bytes, len)`

Returns a String containing the contents of a buffer. If "len" is zero then strlen(buffer) is used. 

`function file_to_bytes(file)`

Returns a pointer to a buffer containing the contents of a file. Memory management of the buffer is the responsibility of the caller (use the free() function). 

`function file_to_text(file)`

Returns a String containing the contents of a file.

`function bytes_to_file(bytes, file, len)`

Writes the contents of a buffer to a file. If "len" is zero then strlen(buffer) is used. 

`function text_to_file(text, file)`

Writes the contents of a String to a file. 

`function text_to_function(script, imports)`

Returns a Function object that encapsulates a script and its imports.

`function file_to_function(file, imports)`

Same as above but using the contents of a file instead of a String. 

`function text_to_task(script, imports)`

Runs a script with the given imports. Returns false on error.

`function file_to_task(file, imports)`

Same as above but using the contents of a file instead of a String. 

`function text_to_module(script, imports)`

Returns a reference to a loaded script.

`function file_to_module(file, imports)`

Same as above but using the contents of a file instead of a String. 

`function text_to_object(script, imports)`

Returns a reference to a loaded object. Script should be in the form of "{ foo: "bar", baz: 1024 }".

`function file_to_object(file, imports)`

Same as above but using the contents of a file instead of a String. 

`function include(file)`

Imports a file directly into the current global space.

`function sizeof(typename)`

Returns the size of some native C type. If typename contains an asterisk ("\*") then the size of a pointer is returned.

`function put(pointer)`

Prints a raw C string or String object. No other types are allowed for this low-level function.

`function fput(stream, pointer)`

Prints a raw C string or String object to a C file stream. No other types are allowed for this low-level function.

`function get_byte(pointer, index)`

Returns the byte at "index" of a raw C buffer.

`function set_byte(pointer, index, value)`

Sets the byte at "index" of a raw C buffer to "value". 

`function get_memory(pointer, index, width)`

Returns the element at "index" of a raw C buffer. The "width" parameter determines how the pointer is dereferenced and MUST be the size of some native C type (int, double, void*, etc).

`function set_memory(pointer, index, value, width)`

Sets the element at "index" of a raw C buffer to "value". The "width" parameter determines how the pointer is dereferenced and MUST be the size of some native C type.

`function argv()`

Fails if argv has not set by the calling C environment (see cosi_main from the Cosi C API). 

`function envp()`

Fails if envp has not set by the calling C environment (see cosi_main from the Cosi C API).  

`function print_partial(args)`

Prints the arguments, inserting a space between each one.

`function print(args)`

Same as above but prints a newline character after all arguments have been processed.

`function gets_bytes(stream)`

Returns a pointer to a buffer containing a line typed by the user (or NULL if the input was empty). Memory management of the buffer is the responsibility of the caller (use the free() function). If unspecified, the default input stream is "stdin".

`function gets_text(stream)`

Returns a String containing a line typed by the user (or null if the input was empty). If unspecified, the default input stream is "stdin".

`function prompt(args)`

Prints all of the arguments and then waits for user input from "stdin". Returns a String containing the line typed by the user (or null if the input was empty).

`function to_text_array(array, skip)`

Converts a raw C array of string pointers to an array of Strings. If "skip" is true then the first element of the C array is not copied (useful when used with argv() for example).

`function argv_to_text_array(skip)`

Converts argv() to an array of Strings. If "skip" is undefined OR true then the first element of the C array is not copied (skipping the script name in argv). Fails if argv has not set by the calling C environment (see cosi_main from the Cosi C API). 

`function script_path()`

Returns the path of the current script, if available. Fails if argv() has not set by the calling C environment (see cosi_main from the Cosi C API).  

`function text_to_ascii(text)`

Helper function to convert a String to an Array of Numbers.

`function ascii_to_text(ascii)`

Helper function to convert an Array of Numbers to String.

`function utf_strlen(text)`

Returns the utf-8 length of a String or raw C pointer.
